<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Multi-Channel Instant Go Live</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
    }

    .wizard-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .wizard-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        overflow: hidden;
        width: 100%;
        max-width: 800px;
        position: relative;
    }

    .wizard-header {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 30px;
        text-align: center;
        position: relative;
    }

    .wizard-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        opacity: 0.3;
    }

    .wizard-header-content {
        position: relative;
        z-index: 1;
    }

    .wizard-title {
        font-size: 28px;
        font-weight: bold;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
    }

    .wizard-subtitle {
        font-size: 16px;
        opacity: 0.9;
        margin-bottom: 20px;
    }

    .progress-bar {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
    }

    .progress-step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        transition: all 0.3s ease;
    }

    .progress-step.active {
        background: #ffd700;
        color: #333;
    }

    .progress-step.completed {
        background: #4CAF50;
        color: white;
    }

    .wizard-content {
        padding: 40px;
    }

    .step {
        display: none;
        animation: fadeIn 0.5s ease-in-out;
    }

    .step.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .step-title {
        font-size: 24px;
        font-weight: bold;
        color: #2d3748;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .step-description {
        color: #718096;
        margin-bottom: 30px;
        font-size: 16px;
    }

    .form-group {
        margin-bottom: 25px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 8px;
        font-size: 16px;
    }

    .form-input {
        width: 100%;
        padding: 15px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: #f8fafc;
    }

    .form-input:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-textarea {
        resize: vertical;
        min-height: 100px;
    }

    .file-upload-area {
        border: 2px dashed #cbd5e0;
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        background: #f8fafc;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .file-upload-area:hover {
        border-color: #667eea;
        background: #f0f4ff;
    }

    .file-upload-area.dragover {
        border-color: #667eea;
        background: #f0f4ff;
    }

    .file-upload-icon {
        font-size: 48px;
        color: #a0aec0;
        margin-bottom: 15px;
    }

    .file-upload-text {
        color: #718096;
        font-size: 16px;
        margin-bottom: 10px;
    }

    .file-upload-hint {
        color: #a0aec0;
        font-size: 14px;
    }

    .thumbnail-preview {
        width: 100%;
        max-width: 300px;
        height: 180px;
        border-radius: 12px;
        object-fit: cover;
        margin: 15px auto;
        display: block;
        border: 2px solid #e2e8f0;
    }

    .button-group {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        flex-wrap: wrap;
    }

    .btn {
        flex: 1;
        min-width: 150px;
        padding: 15px 25px;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
        background: #e2e8f0;
        color: #4a5568;
    }

    .btn-secondary:hover:not(:disabled) {
        background: #cbd5e0;
    }

    .btn-success {
        background: linear-gradient(135deg, #48bb78, #38a169);
        color: white;
        box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
    }

    .btn-success:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .channel-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .channel-card {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 15px;
        padding: 20px;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .channel-card:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    .channel-card.selected {
        border-color: #667eea;
        background: #f0f4ff;
    }

    .channel-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
    }

    .channel-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        font-weight: bold;
    }

    .channel-info h3 {
        color: #2d3748;
        font-size: 16px;
        margin-bottom: 5px;
    }

    .channel-info p {
        color: #718096;
        font-size: 14px;
    }

    .channel-checkbox {
        width: 20px;
        height: 20px;
        accent-color: #667eea;
    }

    .camera-preview {
        background: #000;
        border-radius: 15px;
        overflow: hidden;
        margin-bottom: 30px;
        position: relative;
    }

    .video-preview {
        width: 100%;
        height: 300px;
        object-fit: cover;
        background: #111;
    }

    .camera-overlay {
        position: absolute;
        top: 15px;
        left: 15px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
    }

    .camera-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .camera-btn {
        flex: 1;
        min-width: 120px;
        padding: 12px 20px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        background: white;
        color: #4a5568;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .camera-btn:hover {
        border-color: #667eea;
        color: #667eea;
    }

    .camera-btn.active {
        border-color: #667eea;
        background: #f0f4ff;
        color: #667eea;
    }

    .permission-status {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #667eea;
    }

    .status-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .status-item:last-child {
        margin-bottom: 0;
    }

    .status-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
    }

    .status-icon.granted {
        background: #48bb78;
        color: white;
    }

    .status-icon.denied {
        background: #e53e3e;
        color: white;
    }

    .status-icon.pending {
        background: #f6ad55;
        color: white;
    }

    .live-timer {
        background: linear-gradient(135deg, #e53e3e, #c53030);
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        font-weight: 600;
        font-size: 18px;
        font-family: 'Courier New', monospace;
        animation: livePulse 2s infinite;
        box-shadow: 0 4px 15px rgba(229, 62, 62, 0.3);
        text-align: center;
        margin-bottom: 20px;
    }

    @keyframes livePulse {
        0% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(229, 62, 62, 0); }
        100% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0); }
    }

    .live-badge {
        background: #e53e3e;
        color: white;
        padding: 8px 16px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 600;
        animation: livePulse 2s infinite;
        margin-left: 15px;
    }

    .back-link {
        position: absolute;
        top: 20px;
        left: 20px;
        color: white;
        text-decoration: none;
        font-size: 18px;
        opacity: 0.8;
        transition: opacity 0.3s ease;
    }

    .back-link:hover {
        opacity: 1;
    }

    .error-message {
        background: #fed7d7;
        border: 2px solid #f56565;
        border-radius: 12px;
        padding: 15px;
        color: #742a2a;
        font-weight: 600;
        margin-top: 15px;
    }

    .success-message {
        background: #c6f6d5;
        border: 2px solid #68d391;
        border-radius: 12px;
        padding: 15px;
        color: #22543d;
        font-weight: 600;
        margin-top: 15px;
    }

    @media (max-width: 768px) {
        .wizard-container {
            padding: 10px;
        }
        
        .wizard-content {
            padding: 20px;
        }
        
        .button-group {
            flex-direction: column;
        }
        
        .btn {
            min-width: auto;
        }
        
        .channel-grid {
            grid-template-columns: 1fr;
        }
        
        .camera-controls {
            flex-direction: column;
        }
    }
</style>
</head>
<body>
    <div class="wizard-container">
        <div class="wizard-card">
            <a href="/" class="back-link">
                <i class="fas fa-arrow-left"></i>
            </a>
            
            <div class="wizard-header">
                <div class="wizard-header-content">
                    <h1 class="wizard-title">
                        <i class="fas fa-broadcast-tower"></i>
                        Multi-Channel Go Live
                        <span class="live-badge" id="liveBadge" style="display:none;">‚óè LIVE</span>
                    </h1>
                    <p class="wizard-subtitle">Stream to multiple YouTube channels simultaneously</p>
                    
                    <div class="progress-bar">
                        <div class="progress-step active" id="step1-indicator">1</div>
                        <div class="progress-step" id="step2-indicator">2</div>
                        <div class="progress-step" id="step3-indicator">3</div>
                        <div class="progress-step" id="step4-indicator">4</div>
                    </div>
                </div>
            </div>

            <div class="wizard-content">
                <!-- Step 1: Stream Details Form -->
                <div class="step active" id="step1">
                    <h2 class="step-title">
                        <i class="fas fa-edit"></i>
                        Stream Details
                    </h2>
                    <p class="step-description">Enter your stream title, description, and upload a thumbnail</p>
                    
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-input" id="streamTitle" placeholder="Enter your stream title" maxlength="95" value="Multi-Channel Instant Stream">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input form-textarea" id="streamDesc" placeholder="Describe your stream" maxlength="1000">Go live instantly on all your connected YouTube channels!</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Thumbnail</label>
                        <div class="file-upload-area" id="fileUploadArea">
                            <div class="file-upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="file-upload-text">Click to upload or drag and drop</div>
                            <div class="file-upload-hint">PNG, JPG, GIF up to 2MB</div>
                            <input type="file" id="streamThumb" accept="image/*" style="display: none;">
                        </div>
                        <img id="thumbnailPreview" class="thumbnail-preview" style="display:none;" alt="Thumbnail Preview">
                        <div id="fileInfo" style="display:none;"></div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-secondary" id="saveDraftBtn">
                            <i class="fas fa-save"></i>
                            Save as Draft
                        </button>
                        <button class="btn btn-primary" id="nextToChannelsBtn">
                            <i class="fas fa-arrow-right"></i>
                            Go Live
                        </button>
                    </div>
                </div>

                <!-- Step 2: Channel Selection -->
                <div class="step" id="step2">
                    <h2 class="step-title">
                        <i class="fas fa-users"></i>
                        Select Channels
                    </h2>
                    <p class="step-description">Choose which YouTube channels to stream to</p>
                    
                    <div class="channel-grid" id="channelList">
                        <!-- Channels will be loaded here -->
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-secondary" id="backToDetailsBtn">
                            <i class="fas fa-arrow-left"></i>
                            Back
                        </button>
                        <button class="btn btn-primary" id="nextToCameraBtn" disabled>
                            <i class="fas fa-arrow-right"></i>
                            Continue
                        </button>
                    </div>
                </div>

                <!-- Step 3: Camera & Microphone Setup -->
                <div class="step" id="step3">
                    <h2 class="step-title">
                        <i class="fas fa-camera"></i>
                        Camera & Microphone
                    </h2>
                    <p class="step-description">Allow camera and microphone access to start streaming</p>
                    
                    <div class="permission-status" id="permissionStatus">
                        <div class="status-item">
                            <div class="status-icon pending" id="cameraStatus">
                                <i class="fas fa-clock"></i>
                            </div>
                            <span>Camera Permission: <span id="cameraStatusText">Pending</span></span>
                        </div>
                        <div class="status-item">
                            <div class="status-icon pending" id="microphoneStatus">
                                <i class="fas fa-clock"></i>
                            </div>
                            <span>Microphone Permission: <span id="microphoneStatusText">Pending</span></span>
                        </div>
                    </div>
                    
                    <div class="camera-preview" id="cameraPreview" style="display:none;">
                        <video id="preview" class="video-preview" autoplay muted playsinline></video>
                        <div class="camera-overlay">
                            <i class="fas fa-camera"></i>
                            Camera Preview
                        </div>
                    </div>
                    
                    <div class="camera-controls" id="cameraControls" style="display:none;">
                        <button class="camera-btn" id="frontCameraBtn">
                            <i class="fas fa-mobile-alt"></i>
                            Front Camera
                        </button>
                        <button class="camera-btn" id="backCameraBtn">
                            <i class="fas fa-camera"></i>
                            Back Camera
                        </button>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-secondary" id="backToChannelsBtn">
                            <i class="fas fa-arrow-left"></i>
                            Back
                        </button>
                        <button class="btn btn-primary" id="requestPermissionsBtn">
                            <i class="fas fa-key"></i>
                            Allow Access
                        </button>
                        <button class="btn btn-success" id="startStreamingBtn" style="display:none;">
                            <i class="fas fa-play"></i>
                            Start Streaming
                        </button>
                    </div>
                </div>

                <!-- Step 4: Live Streaming -->
                <div class="step" id="step4">
                    <h2 class="step-title">
                        <i class="fas fa-broadcast-tower"></i>
                        Live Streaming
                    </h2>
                    <p class="step-description">You're now live! Monitor your stream and viewer counts</p>
                    
                    <div class="live-timer" id="liveTimer" style="display:none;">00:00:00</div>
                    
                    <div class="camera-preview">
                        <video id="livePreview" class="video-preview" autoplay muted playsinline></video>
                        <div class="camera-overlay">
                            <i class="fas fa-circle" style="color: #e53e3e;"></i>
                            Live Stream
                        </div>
                    </div>
                    
                    <div id="liveUrls" style="margin-bottom: 20px;"></div>
                    
                    <div class="button-group">
                        <button class="btn btn-secondary" id="backToCameraBtn">
                            <i class="fas fa-arrow-left"></i>
                            Back
                        </button>
                        <button class="btn btn-success" id="stopStreamingBtn">
                            <i class="fas fa-stop"></i>
                            Stop Streaming
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
// Wizard state management
let currentStep = 1;
let streamData = {
    title: '',
    description: '',
    thumbnail: null,
    selectedChannels: []
};

// Media and streaming variables
let mediaRecorder, stream;
let isStreaming = false;
let liveTimerInterval;
let viewerPollInterval;
let aggressivePollingInterval;
let streamStartTime;
let currentCamera = 'user'; // 'user' for front camera, 'environment' for back camera
let currentSessionId = null; // Track current streaming session

// DOM elements
const step1 = document.getElementById('step1');
const step2 = document.getElementById('step2');
const step3 = document.getElementById('step3');
const step4 = document.getElementById('step4');

const step1Indicator = document.getElementById('step1-indicator');
const step2Indicator = document.getElementById('step2-indicator');
const step3Indicator = document.getElementById('step3-indicator');
const step4Indicator = document.getElementById('step4-indicator');

// Step 1 elements
const streamTitle = document.getElementById('streamTitle');
const streamDesc = document.getElementById('streamDesc');
const streamThumb = document.getElementById('streamThumb');
const fileUploadArea = document.getElementById('fileUploadArea');
const thumbnailPreview = document.getElementById('thumbnailPreview');
const fileInfo = document.getElementById('fileInfo');
const saveDraftBtn = document.getElementById('saveDraftBtn');
const nextToChannelsBtn = document.getElementById('nextToChannelsBtn');

// Step 2 elements
const channelList = document.getElementById('channelList');
const backToDetailsBtn = document.getElementById('backToDetailsBtn');
const nextToCameraBtn = document.getElementById('nextToCameraBtn');

// Step 3 elements
const permissionStatus = document.getElementById('permissionStatus');
const cameraStatus = document.getElementById('cameraStatus');
const cameraStatusText = document.getElementById('cameraStatusText');
const microphoneStatus = document.getElementById('microphoneStatus');
const microphoneStatusText = document.getElementById('microphoneStatusText');
const cameraPreview = document.getElementById('cameraPreview');
const cameraControls = document.getElementById('cameraControls');
const preview = document.getElementById('preview');
const frontCameraBtn = document.getElementById('frontCameraBtn');
const backCameraBtn = document.getElementById('backCameraBtn');
const backToChannelsBtn = document.getElementById('backToChannelsBtn');
const requestPermissionsBtn = document.getElementById('requestPermissionsBtn');
const startStreamingBtn = document.getElementById('startStreamingBtn');

// Step 4 elements
const liveBadge = document.getElementById('liveBadge');
const liveTimer = document.getElementById('liveTimer');
const liveUrls = document.getElementById('liveUrls');
const livePreview = document.getElementById('livePreview');
const backToCameraBtn = document.getElementById('backToCameraBtn');
const stopStreamingBtn = document.getElementById('stopStreamingBtn');

// Wizard navigation functions
function showStep(step) {
    // Hide all steps
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    
    // Show current step
    document.getElementById(`step${step}`).classList.add('active');
    
    // Update progress indicators
    document.querySelectorAll('.progress-step').forEach((indicator, index) => {
        indicator.classList.remove('active', 'completed');
        if (index + 1 < step) {
            indicator.classList.add('completed');
        } else if (index + 1 === step) {
            indicator.classList.add('active');
        }
    });
    
    currentStep = step;
}

// Step 1: Stream Details
function initializeStep1() {
    // File upload handling
    fileUploadArea.addEventListener('click', () => streamThumb.click());
    
    fileUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadArea.classList.add('dragover');
    });
    
    fileUploadArea.addEventListener('dragleave', () => {
        fileUploadArea.classList.remove('dragover');
    });
    
    fileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            streamThumb.files = files;
            handleThumbnailUpload({ target: streamThumb });
        }
    });
    
    streamThumb.addEventListener('change', handleThumbnailUpload);
    
    // Button handlers
    saveDraftBtn.addEventListener('click', saveDraft);
    nextToChannelsBtn.addEventListener('click', goToStep2);
}

function handleThumbnailUpload(event) {
    const file = event.target.files[0];
    if (file) {
        // Check file size (2MB = 2097152 bytes)
        const maxSize = 2 * 1024 * 1024;
        if (file.size > maxSize) {
            alert(`File too large! Please select an image smaller than 2MB. Current size: ${(file.size / 1024 / 1024).toFixed(2)}MB`);
            event.target.value = '';
            return;
        }
        
        // Check file type
        if (!file.type.startsWith('image/')) {
            alert('Please select a valid image file (JPG, PNG, GIF, etc.)');
            event.target.value = '';
            return;
        }
        
        // Show file info
        const originalSize = (file.size / 1024 / 1024).toFixed(2);
        fileInfo.textContent = `Original: ${originalSize}MB`;
        fileInfo.style.display = 'block';
        
        // Compress image if needed
        compressImage(file, function(compressedFile) {
            const reader = new FileReader();
            reader.onload = function(e) {
                thumbnailPreview.src = e.target.result;
                thumbnailPreview.style.display = 'block';
                
                // Show compression info
                const compressedSize = (compressedFile.size / 1024 / 1024).toFixed(2);
                fileInfo.innerHTML = `Original: ${originalSize}MB ‚Üí Compressed: ${compressedSize}MB <span style="color:#4caf50;">‚úì</span>`;
                
                // Update the file input with compressed file
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(compressedFile);
                event.target.files = dataTransfer.files;
            };
            reader.readAsDataURL(compressedFile);
        });
    }
}

function compressImage(file, callback) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = function() {
        // Calculate new dimensions (max 1280x720 for YouTube thumbnails)
        let { width, height } = img;
        const maxWidth = 1280;
        const maxHeight = 720;
        
        if (width > maxWidth || height > maxHeight) {
            const ratio = Math.min(maxWidth / width, maxHeight / height);
            width *= ratio;
            height *= ratio;
        }
        
        canvas.width = width;
        canvas.height = height;
        
        // Draw and compress
        ctx.drawImage(img, 0, 0, width, height);
        
        canvas.toBlob(function(blob) {
            // Create a new file with compressed data
            const compressedFile = new File([blob], file.name, {
                type: 'image/jpeg',
                lastModified: Date.now()
            });
            callback(compressedFile);
        }, 'image/jpeg', 0.8); // 80% quality
    };
    
    img.src = URL.createObjectURL(file);
}

async function saveDraft() {
    // Validate form
    if (!streamTitle.value.trim()) {
        alert('Please enter a stream title');
        return;
    }
    
    // Prepare form data
    const formData = new FormData();
    formData.append('title', streamTitle.value);
    formData.append('description', streamDesc.value);
    formData.append('selected_channels', JSON.stringify(streamData.selectedChannels || []));
    
    // Add thumbnail if present
    if (streamThumb.files[0]) {
        formData.append('thumbnail', streamThumb.files[0]);
    }
    
    try {
        const response = await fetch('/save_draft', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Draft saved successfully!');
            // Store the draft ID for potential future use
            streamData.draftId = result.draft_id;
        } else {
            alert('Error saving draft: ' + result.message);
        }
    } catch (error) {
        console.error('Error saving draft:', error);
        alert('Error saving draft. Please try again.');
    }
}

function goToStep2() {
    // Validate form
    if (!streamTitle.value.trim()) {
        alert('Please enter a stream title');
        return;
    }
    
    // Save form data
    streamData.title = streamTitle.value;
    streamData.description = streamDesc.value;
    streamData.thumbnail = streamThumb.files[0];
    
    // Load channels and go to step 2
    loadChannels();
    showStep(2);
}

// Step 2: Channel Selection
function initializeStep2() {
    backToDetailsBtn.addEventListener('click', () => showStep(1));
    nextToCameraBtn.addEventListener('click', goToStep3);
}

function loadChannels() {
    fetch('/multi_instant_channel_list')
        .then(r => r.json())
        .then(data => {
            if (data.channels) {
                channelList.innerHTML = data.channels.map(c => `
                    <div class="channel-card" data-channel-id="${c.channel_id}">
                        <div class="channel-header">
                            <input type="checkbox" class="channel-checkbox" data-channel-id="${c.channel_id}" checked>
                            <div class="channel-avatar">${(c.channel_name || c.channel_id).slice(0,2).toUpperCase()}</div>
                            <div class="channel-info">
                                <h3>${c.channel_name || c.channel_id}</h3>
                                <p>${c.channel_id}</p>
                            </div>
                        </div>
                    </div>`).join('');
                
                // Add event listeners
                document.querySelectorAll('.channel-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        if (e.target.type !== 'checkbox') {
                            const checkbox = card.querySelector('.channel-checkbox');
                            checkbox.checked = !checkbox.checked;
                            updateChannelSelection();
                        }
                    });
                });
                
                document.querySelectorAll('.channel-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', updateChannelSelection);
                });
                
                // Restore selected channels if loading from draft
                if (streamData.selectedChannels.length > 0) {
                    streamData.selectedChannels.forEach(channelId => {
                        const checkbox = document.querySelector(`input[data-channel-id="${channelId}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                }
                
                updateChannelSelection();
            }
        });
}

function updateChannelSelection() {
    const selectedChannels = Array.from(document.querySelectorAll('.channel-checkbox:checked'))
        .map(cb => cb.getAttribute('data-channel-id'));
    
    streamData.selectedChannels = selectedChannels;
    
    // Update channel cards visual state
    document.querySelectorAll('.channel-card').forEach(card => {
        const checkbox = card.querySelector('.channel-checkbox');
        if (checkbox.checked) {
            card.classList.add('selected');
        } else {
            card.classList.remove('selected');
        }
    });
    
    // Enable/disable continue button
    nextToCameraBtn.disabled = selectedChannels.length === 0;
}

function goToStep3() {
    if (streamData.selectedChannels.length === 0) {
        alert('Please select at least one channel');
        return;
    }
    showStep(3);
}

// Step 3: Camera & Microphone Setup
function initializeStep3() {
    backToChannelsBtn.addEventListener('click', () => showStep(2));
    requestPermissionsBtn.addEventListener('click', requestPermissions);
    startStreamingBtn.addEventListener('click', goToStep4);
    frontCameraBtn.addEventListener('click', () => switchCamera('user'));
    backCameraBtn.addEventListener('click', () => switchCamera('environment'));
}

async function requestPermissions() {
    try {
        // Request camera and microphone access
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: currentCamera }, 
            audio: true 
        });
        
        // Update permission status
        cameraStatus.className = 'status-icon granted';
        cameraStatus.innerHTML = '<i class="fas fa-check"></i>';
        cameraStatusText.textContent = 'Granted';
        
        microphoneStatus.className = 'status-icon granted';
        microphoneStatus.innerHTML = '<i class="fas fa-check"></i>';
        microphoneStatusText.textContent = 'Granted';
        
        // Show camera preview and controls
        preview.srcObject = stream;
        cameraPreview.style.display = 'block';
        cameraControls.style.display = 'flex';
        
        // Show start streaming button
        requestPermissionsBtn.style.display = 'none';
        startStreamingBtn.style.display = 'flex';
        
    } catch (error) {
        console.error('Error accessing media devices:', error);
        
        // Update permission status to denied
        cameraStatus.className = 'status-icon denied';
        cameraStatus.innerHTML = '<i class="fas fa-times"></i>';
        cameraStatusText.textContent = 'Denied';
        
        microphoneStatus.className = 'status-icon denied';
        microphoneStatus.innerHTML = '<i class="fas fa-times"></i>';
        microphoneStatusText.textContent = 'Denied';
        
        alert('Camera and microphone access is required to stream. Please allow access and try again.');
    }
}

function switchCamera(facingMode) {
    if (stream) {
        // Stop current stream
        stream.getTracks().forEach(track => track.stop());
    }
    
    currentCamera = facingMode;
    
    // Update button states
    frontCameraBtn.classList.toggle('active', facingMode === 'user');
    backCameraBtn.classList.toggle('active', facingMode === 'environment');
    
    // Request new stream
    navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: facingMode }, 
        audio: true 
    }).then(newStream => {
        stream = newStream;
        preview.srcObject = stream;
    }).catch(error => {
        console.error('Error switching camera:', error);
    });
}

function goToStep4() {
    if (!stream) {
        alert('Please allow camera and microphone access first');
        return;
    }
    
    // Start the actual streaming process
    startMultiChannelStreaming();
    showStep(4);
}

// Step 4: Live Streaming
function initializeStep4() {
    backToCameraBtn.addEventListener('click', () => showStep(3));
    stopStreamingBtn.addEventListener('click', stopStreaming);
}

async function startMultiChannelStreaming() {
    try {
        // Show live badge and timer
        liveBadge.style.display = 'inline-block';
        liveTimer.style.display = 'block';
        
        // Copy stream to live preview
        livePreview.srcObject = stream;
        
        // Create history session
        const sessionData = {
            start_time: new Date().toISOString(),
            title: streamData.title,
            description: streamData.description,
            channels_used: streamData.selectedChannels,
            thumbnail_filename: streamData.thumbnail ? `thumb_${Date.now()}.jpg` : null,
            status: 'streaming'
        };
        
        // Save thumbnail if exists
        if (streamData.thumbnail) {
            const formData = new FormData();
            formData.append('thumbnail', streamData.thumbnail);
            formData.append('filename', sessionData.thumbnail_filename);
            
            try {
                await fetch('/save_thumbnail', {
                    method: 'POST',
                    body: formData
                });
            } catch (error) {
                console.error('Error saving thumbnail:', error);
            }
        }
        
        // Add session to history
        try {
            const historyResponse = await fetch('/add_stream_session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(sessionData)
            });
            
            const historyResult = await historyResponse.json();
            if (historyResult.success) {
                currentSessionId = historyResult.session_id;
            }
        } catch (error) {
            console.error('Error creating history session:', error);
        }
        
        // Create form data for stream creation
        let formData = new FormData();
        formData.append('title', streamData.title);
        formData.append('description', streamData.description);
        if (streamData.thumbnail) {
            formData.append('thumbnail', streamData.thumbnail);
        }
        formData.append('selected_channels', JSON.stringify(streamData.selectedChannels));
        
        // Create streams
        let resp = await fetch('/multi_instant_create_stream', { method: 'POST', body: formData });
        let result = await resp.json();
        
        if (result.error) {
            throw new Error(result.error);
        }
        
        // Start media recording
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp8,opus' });
        isStreaming = true;
        
        mediaRecorder.ondataavailable = async function(e) {
            if (e.data.size > 0 && isStreaming) {
                const chunkForm = new FormData();
                chunkForm.append('chunk', e.data);
                await fetch('/multi_instant_upload_stream', { method: 'POST', body: chunkForm });
            }
        };
        
        mediaRecorder.start(1000);
        
        // Go live
        let liveResp = await fetch('/multi_instant_go_live', { method: 'POST' });
        let liveData = await liveResp.json();
        
        // Display live URLs
        if (liveData.live_urls && Object.keys(liveData.live_urls).length > 0) {
            let statusHtml = '<h4>Live Channels:</h4>';
            for (const [cid, url] of Object.entries(liveData.live_urls)) {
                statusHtml += `<div style="margin-bottom: 10px; padding: 10px; background: #f0f4ff; border-radius: 8px;" data-channel-id="${cid}">
                    <strong>${cid}</strong><br>
                    <a href="${url}" target="_blank" style="color: #667eea;">${url}</a>
                    <span class="viewer-count" style="color: #48bb78; font-weight: bold; margin-left: 10px;">‚óè Live</span>
                </div>`;
            }
            liveUrls.innerHTML = statusHtml;
            
            // Start timer
            startLiveTimer();
            
            // Start viewer polling
            startViewerPolling();
        }
        
        if (liveData.errors) {
            let errorHtml = '<h4>Errors:</h4>';
            for (const [cid, msg] of Object.entries(liveData.errors)) {
                errorHtml += `<div style="margin-bottom: 10px; padding: 10px; background: #fed7d7; border-radius: 8px; color: #742a2a;">
                    <strong>${cid}</strong>: ${msg}
                </div>`;
            }
            liveUrls.innerHTML += errorHtml;
        }
        
    } catch (error) {
        console.error('Error starting stream:', error);
        alert('Error starting stream: ' + error.message);
        showStep(3);
    }
}

function startLiveTimer() {
    streamStartTime = Date.now();
    function updateTimer() {
        const elapsed = Math.floor((Date.now() - streamStartTime) / 1000);
        const h = String(Math.floor(elapsed/3600)).padStart(2,'0');
        const m = String(Math.floor((elapsed%3600)/60)).padStart(2,'0');
        const s = String(elapsed%60).padStart(2,'0');
        liveTimer.textContent = `${h}:${m}:${s}`;
    }
    updateTimer();
    liveTimerInterval = setInterval(updateTimer, 1000);
}

function startViewerPolling() {
    if (viewerPollInterval) clearInterval(viewerPollInterval);
    if (aggressivePollingInterval) clearInterval(aggressivePollingInterval);
    
    // Immediate first poll
    pollViewers();
    
    // Aggressive polling for first 2 minutes (every 1 second)
    aggressivePollingInterval = setInterval(() => {
        pollViewers();
        // Switch to normal polling after 2 minutes
        if (Date.now() - streamStartTime > 120000) {
            clearInterval(aggressivePollingInterval);
            aggressivePollingInterval = null;
            viewerPollInterval = setInterval(pollViewers, 2000);
        }
    }, 1000);
    
    // Fallback normal polling (every 2 seconds)
    viewerPollInterval = setInterval(pollViewers, 2000);
}

async function stopStreaming() {
    isStreaming = false;
    
    // Stop media recording
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
    }
    
    // Stop camera stream
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
    }
    
    // Stop backend streaming
    fetch('/multi_instant_stop_stream', { method: 'POST' });
    
    // Update history session with end time and duration
    if (currentSessionId) {
        const endTime = new Date().toISOString();
        const duration = liveTimer.textContent || '00:00:00';
        
        try {
            await fetch(`/update_stream_session/${currentSessionId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    end_time: endTime,
                    duration: duration,
                    status: 'completed',
                    live_urls: getCurrentLiveUrls(),
                    viewer_stats: getCurrentViewerStats()
                })
            });
        } catch (error) {
            console.error('Error updating history session:', error);
        }
        
        currentSessionId = null;
    }
    
    // Clear intervals
    if (liveTimerInterval) clearInterval(liveTimerInterval);
    if (viewerPollInterval) clearInterval(viewerPollInterval);
    if (aggressivePollingInterval) clearInterval(aggressivePollingInterval);
    
    // Reset UI
    liveBadge.style.display = 'none';
    liveTimer.style.display = 'none';
    liveTimer.textContent = '00:00:00';
    liveUrls.innerHTML = '';
    
    // Go back to step 3
    showStep(3);
}

// Helper functions for history tracking
function getCurrentLiveUrls() {
    const urls = {};
    const urlElements = liveUrls.querySelectorAll('a[href*="youtube.com"]');
    urlElements.forEach(link => {
        const channelId = link.closest('[data-channel-id]')?.getAttribute('data-channel-id');
        if (channelId) {
            urls[channelId] = link.href;
        }
    });
    return urls;
}

function getCurrentViewerStats() {
    const stats = {};
    const viewerElements = liveUrls.querySelectorAll('.viewer-count');
    viewerElements.forEach(element => {
        const channelId = element.closest('[data-channel-id]')?.getAttribute('data-channel-id');
        const viewerText = element.textContent;
        const viewerCount = viewerText.match(/\d+/);
        if (channelId && viewerCount) {
            stats[channelId] = parseInt(viewerCount[0]);
        }
    });
    return stats;
}

async function pollViewers() {
    try {
        let resp = await fetch('/multi_instant_viewers');
        let data = await resp.json();
        
        // Update viewer counts in live URLs section
        for (const [cid, viewers] of Object.entries(data)) {
            const channelDiv = liveUrls.querySelector(`[data-channel-id="${cid}"]`);
            if (channelDiv) {
                const viewerSpan = channelDiv.querySelector('.viewer-count');
                if (viewerSpan) {
                    if (viewers === null) {
                        viewerSpan.innerHTML = '<span style="color:#f6ad55;">‚è≥ Loading...</span>';
                    } else {
                        viewerSpan.innerHTML = `<span style="color:#48bb78;font-weight:bold;">üë• ${viewers}</span>`;
                    }
                }
            }
        }
    } catch (error) {
        console.error('Error fetching viewer counts:', error);
    }
}

// Initialize the wizard
document.addEventListener('DOMContentLoaded', function() {
    initializeStep1();
    initializeStep2();
    initializeStep3();
    initializeStep4();
    
    // Load draft from sessionStorage if exists (from dashboard)
    const loadedDraft = sessionStorage.getItem('loadedDraft');
    if (loadedDraft) {
        try {
            const draft = JSON.parse(loadedDraft);
            streamTitle.value = draft.title || '';
            streamDesc.value = draft.description || '';
            streamData.selectedChannels = draft.selected_channels || [];
            
            // Load thumbnail if exists
            if (draft.thumbnail_filename) {
                const thumbnailUrl = `/uploads/${draft.thumbnail_filename}`;
                thumbnailPreview.src = thumbnailUrl;
                thumbnailPreview.style.display = 'block';
                fileInfo.textContent = 'Thumbnail loaded from draft';
                fileInfo.style.display = 'block';
                
                // Hide the upload area since we have a thumbnail
                fileUploadArea.style.display = 'none';
            }
            
            // Clear the loaded draft from sessionStorage
            sessionStorage.removeItem('loadedDraft');
            
            // Show success message
            alert('Draft loaded successfully! You can now continue with your stream setup.');
            
            // If we have selected channels, we should go to step 2 to show them
            if (streamData.selectedChannels.length > 0) {
                // Load channels and go to step 2
                loadChannels();
                showStep(2);
            }
        } catch (error) {
            console.error('Error loading draft:', error);
        }
    }
    
    // Load saved draft from localStorage if exists (fallback)
    const savedDraft = localStorage.getItem('streamDraft');
    if (savedDraft && !loadedDraft) {
        const draft = JSON.parse(savedDraft);
        streamTitle.value = draft.title;
        streamDesc.value = draft.description;
    }
});

</script>
</body>
</html>
